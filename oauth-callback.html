<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Sorbet - OAuth Callback</title>
      <style>
          body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              margin: 0;
              padding: 0;
              display: flex;
              justify-content: center;
              align-items: center;
              min-height: 100vh;
              color: white;
          }
          .container {
              background: rgba(255, 255, 255, 0.1);
              backdrop-filter: blur(10px);
              border-radius: 20px;
              padding: 40px;
              text-align: center;
              box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
              max-width: 400px;
              width: 90%;
          }
          .spinner {
              border: 3px solid rgba(255, 255, 255, 0.3);
              border-top: 3px solid white;
              border-radius: 50%;
              width: 40px;
              height: 40px;
              animation: spin 1s linear infinite;
              margin: 0 auto 20px;
          }
          @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
          }
          h1 { margin: 0 0 10px 0; font-size: 24px; font-weight: 600; }
          p { margin: 0 0 20px 0; opacity: 0.9; line-height: 1.5; }
          .error {
              background: rgba(220, 53, 69, 0.8);
              padding: 15px;
              border-radius: 10px;
              margin-top: 10px;
          }
          .success {
              background: rgba(40, 167, 69, 0.8);
              padding: 15px;
              border-radius: 10px;
              margin-top: 10px;
          }
          .debug {
              background: rgba(108, 117, 125, 0.8);
              padding: 10px;
              border-radius: 5px;
              margin-top: 10px;
              font-size: 12px;
              text-align: left;
          }
      </style>
  </head>
  <body>
      <div class="container">
          <div class="spinner"></div>
          <h1>Processing Authorization</h1>
          <p id="bank-message">Please wait while we complete your connection...</p>
          <div id="status"></div>
          <div id="debug"></div>
      </div>

      <script>
          (function() {
              const statusDiv = document.getElementById('status');
              const bankMessage = document.getElementById('bank-message');
              const debugDiv = document.getElementById('debug');

              const urlParams = new URLSearchParams(window.location.search);
              const code = urlParams.get('code');
              const state = urlParams.get('state') || '';
              const error = urlParams.get('error');
              const errorDescription = urlParams.get('error_description');

              // Debug logging
              console.log('OAuth Callback Debug:');
              console.log('URL:', window.location.href);
              console.log('Code:', code);
              console.log('State:', state);
              console.log('Error:', error);
              console.log('Error Description:', errorDescription);
              console.log('Referrer:', document.referrer);

              // Debug display
              debugDiv.innerHTML = `
                  <div class="debug">
                      <strong>Debug Info:</strong><br>
                      Code: ${code ? 'Present' : 'Missing'}<br>
                      State: "${state}"<br>
                      Error: ${error || 'None'}<br>
                      Referrer: ${document.referrer}<br>
                  </div>
              `;

              // Determine bank from state parameter or referrer
              let bankName = 'Bank';
              let bankParam = 'revolut'; // Default

              if (state.includes('boc')) {
                  bankName = 'Bank of Cyprus';
                  bankParam = 'boc';
              } else if (state.includes('nbog')) {
                  bankName = 'National Bank of Greece';
                  bankParam = 'nbog';
              } else if (state.includes('coop')) {
                  bankName = 'Coop Pank';
                  bankParam = 'coop';
              } else if (state.includes('revolut') || state.includes('bank_connection')) {
                  bankName = 'Revolut';
                  bankParam = 'revolut';
              } else if (document.referrer.includes('bankofcyprus.com') || 
                         document.referrer.includes('sandbox-apis.bankofcyprus.com')) {
                  // Enhanced BoC detection
                  bankName = 'Bank of Cyprus';
                  bankParam = 'boc';
              } else if (document.referrer.includes('nbg.gr')) {
                  bankName = 'National Bank of Greece';
                  bankParam = 'nbog';
              } else if (document.referrer.includes('cooppank.ee')) {
                  bankName = 'Coop Pank';
                  bankParam = 'coop';
              }

              console.log('Detected bank:', bankParam, '(' + bankName + ')');

              // Update the message based on the bank
              bankMessage.textContent = `Please wait while we complete your ${bankName} connection...`;

              if (error) {
                  statusDiv.innerHTML = `
                      <div class="error">
                          <strong>Authorization Failed</strong><br>
                          Error: ${error}<br>
                          ${errorDescription ? 'Description: ' + errorDescription : ''}
                      </div>
                  `;
                  return;
              }

              if (!code) {
                  statusDiv.innerHTML = `
                      <div class="error">
                          <strong>No Authorization Code</strong><br>
                          The authorization process did not complete properly.
                      </div>
                  `;
                  return;
              }

              // Show success message
              statusDiv.innerHTML = `
                  <div class="success">
                      <strong>Authorization Successful!</strong><br>
                      Redirecting to Sorbet...
                  </div>
              `;

              // Determine redirect URL
              let redirectUrl;

              if (state.includes('payment')) {
                  // Payment flow
                  redirectUrl = `http://localhost:8443/payments/callback?code=${encodeURIComponent(code)}&state=${encodeURIComponent(state)}`;
              } else {
                  // Bank connection flow - add bank parameter to help identification
                  const stateParam = state || ('bank_connection_' + bankParam);
                  redirectUrl = `http://localhost:8443/eu_bank_connections/callback?code=${encodeURIComponent(code)}&state=${encodeURIComponent(stateParam)}&bank=${bankParam}`;
              }

              console.log('Redirecting to:', redirectUrl);

              // Redirect after a short delay
              setTimeout(() => {
                  window.location.href = redirectUrl;
              }, 2000);

          })();
      </script>
  </body>
</html>
