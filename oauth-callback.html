<!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Sorbet - OAuth Callback</title>
      <style>
          body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              margin: 0;
              padding: 0;
              display: flex;
              justify-content: center;
              align-items: center;
              min-height: 100vh;
              color: white;
          }
          .container {
              background: rgba(255, 255, 255, 0.1);
              backdrop-filter: blur(10px);
              border-radius: 20px;
              padding: 40px;
              text-align: center;
              box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
              max-width: 400px;
              width: 90%;
          }
          .spinner {
              border: 3px solid rgba(255, 255, 255, 0.3);
              border-top: 3px solid white;
              border-radius: 50%;
              width: 40px;
              height: 40px;
              animation: spin 1s linear infinite;
              margin: 0 auto 20px;
          }
          @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
          }
          h1 { margin: 0 0 10px 0; font-size: 24px; font-weight: 600; }
          p { margin: 0 0 20px 0; opacity: 0.9; line-height: 1.5; }
          .error {
              background: rgba(220, 53, 69, 0.8);
              padding: 15px;
              border-radius: 10px;
              margin-top: 10px;
          }
          .success {
              background: rgba(40, 167, 69, 0.8);
              padding: 15px;
              border-radius: 10px;
              margin-top: 10px;
          }
      </style>
  </head>
  <body>
      <div class="container">
          <div class="spinner"></div>
          <h1>Processing Authorization</h1>
          <p id="bank-message">Please wait while we complete your connection...</p>
          <div id="status"></div>
      </div>

      <script>
          (function() {
              const statusDiv = document.getElementById('status');
              const bankMessage = document.getElementById('bank-message');

              const urlParams = new URLSearchParams(window.location.search);
              const code = urlParams.get('code');
              const state = urlParams.get('state') || '';
              const error = urlParams.get('error');
              const errorDescription = urlParams.get('error_description');

              // Determine bank from state parameter
              let bankName = 'Bank';
              if (state.includes('boc')) {
                  bankName = 'Bank of Cyprus';
              } else if (state.includes('nbog')) {
                  bankName = 'National Bank of Greece';
              } else if (state.includes('coop')) {
                  bankName = 'Coop Pank';
              } else if (state.includes('revolut') || state.includes('bank_connection')) {
                  bankName = 'Revolut';
              }

              // Update the message based on the bank
              bankMessage.textContent = `Please wait while we complete your ${bankName} 
  connection...`;

              if (error) {
                  statusDiv.innerHTML = `
                      <div class="error">
                          <strong>Authorization Failed</strong><br>
                          Error: ${error}<br>
                          ${errorDescription ? `Description: ${errorDescription}` : ''}
                      </div>
                  `;
                  return;
              }

              if (!code) {
                  statusDiv.innerHTML = `
                      <div class="error">
                          <strong>No Authorization Code</strong><br>
                          The authorization process did not complete properly.
                      </div>
                  `;
                  return;
              }

              // Show success message
              statusDiv.innerHTML = `
                  <div class="success">
                      <strong>Authorization Successful!</strong><br>
                      Redirecting to Sorbet...
                  </div>
              `;

              // Determine redirect URL based on state parameter
              let redirectUrl;

              if (state.includes('payment')) {
                  // Payment flow
                  redirectUrl = `http://localhost:3000/payments/callback?code=${encodeURIComponen
  t(code)}&state=${encodeURIComponent(state)}`;
              } else {
                  // Bank connection flow (includes BoC, NBOG, Coop, Revolut)
                  redirectUrl = `http://localhost:3000/eu_bank_connections/callback?code=${encode
  URIComponent(code)}&state=${encodeURIComponent(state)}`;
              }

              console.log('Redirecting to:', redirectUrl);

              // Redirect after a short delay
              setTimeout(() => {
                  window.location.href = redirectUrl;
              }, 2000);

          })();
      </script>
  </body>
  </html>
